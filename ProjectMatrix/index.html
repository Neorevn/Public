<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Matrix Has You...</title>
    <style>
        body {
            font-family: 'monospace', sans-serif;
            text-align: center;
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.7;
        }

        h1 {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
            font-size: 6em;
        }

        h2 {
            color: #ffffff;
            font-size: 1.2em;
            margin-bottom: 30px;
            position: relative;
            z-index: 2;
        }

        form {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 20px;
            border: none;
            width: 80%;
            max-width: 600px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        form div {
            margin-bottom: 15px;
            width: 100%;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #00ff00;
            font-size: 1.1em;
        }

        input[type="file"] {
            padding: 12px;
            border: 2px solid #006400;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            background-color: #000;
            color: #00ff00;
            font-size: 1.1em;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 10px;
        }

        input[type="file"]::-webkit-file-upload-button {
            background-color: #006400;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 0 4px 4px 0;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        input[type="file"]::-webkit-file-upload-button:hover {
            background-color: #00ff00;
            color: #000;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            width: 100%;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 0 5px #00ff00;
            margin: 5px;
        }

        #uploadButton {
            background-color: #ff0000;
        }

        #uploadButton:hover {
            background-color: #b22222;
            box-shadow: 0 0 15px #ff0000;
        }

        #bluePillButton {
            background-color: #00008b;
        }

        #bluePillButton:hover {
            background-color: #0000cd;
            box-shadow: 0 0 15px #0000cd;
        }

        #message {
            margin-top: 20px;
            font-size: 1.2em;
            color: #00ff00;
            position: relative;
            z-index: 2;
        }

        #loading-animation-container {
            margin-top: 20px;
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            z-index: 2;
            width: 80%;
            max-width: 600px;
            min-height: 100px; /* Ensure it has some height */
        }

        .loading-line {
            font-family: 'monospace', sans-serif;
            color: #00ff00;
            white-space: nowrap;
            opacity: 0;
            position: relative;
            animation: growAndFade 2s ease-in-out forwards;
            margin-bottom: 2px;
        }

        .loading-line.flicker {
            animation: growAndFade 2s ease-in-out forwards, matrix-flicker 0.1s steps(2, end) infinite;
        }

        @keyframes growAndFade {
            0% {
                width: 0;
                opacity: 0;
            }

            20% {
                opacity: 0.8;
                width: 20%;
            }

            80% {
                opacity: 0.8;
                width: 80%;
            }

            100% {
                width: 100%;
                opacity: 0;
            }
        }

        @keyframes matrix-flicker {
            0%, 100% {
                text-shadow: 0 0 8px #00ff00;
            }

            50% {
                text-shadow: none;
            }
        }

        #transcript {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #006400;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            text-align: left;
            white-space: pre-wrap;
            font-family: 'monospace', sans-serif;
            font-size: 1em;
            color: #00ff00;
            display: none;
            width: 80%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 15px #00ff00;
            position: relative;
            z-index: 2;
        }

        #transcript h2 {
            font-size: 1.7em;
            margin-bottom: 15px;
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        #transcriptText {
            line-height: 1.6;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <canvas id="matrixCanvas"></canvas>
    <h1>The Matrix Has You...</h1>
    <h2>Choose an MP3 to upload to the matrix and I'll show you how deep the rabbit hole goes</h2>
    <form id="uploadForm">
        <div>
            <label for="fileInput">Choose MP3 File:</label>
            <input type="file" id="fileInput" accept="audio/mpeg, audio/mp3" />
        </div>
        <div class="button-container">
            <button id="uploadButton" type="submit">Take the Red Pill</button>
            <button id="bluePillButton" type="button">Take the Blue Pill</button>
        </div>
    </form>

    <div id="message"></div>
    <div id="loading-animation-container"></div>  <div id="transcript">
        <h2>Transcription:</h2>
        <p id="transcriptText"></p>
    </div>

    <script>
        const uploadForm = document.getElementById("uploadForm");
        const uploadButton = document.getElementById("uploadButton");
        const bluePillButton = document.getElementById("bluePillButton");
        const fileInput = document.getElementById("fileInput");
        const messageDiv = document.getElementById("message");
        const loadingAnimationContainer = document.getElementById("loading-animation-container");
        const transcriptDiv = document.getElementById("transcript");
        const transcriptTextParagraph = document.getElementById("transcriptText");
        // IMPORTANT: Replace with your actual API Gateway URL
        const API_BASE_URL = "https://a4kvebgqh6.execute-api.us-east-1.amazonaws.com/prod";

        // Matrix Effect Script
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズヅブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const chars = katakana + latin + nums;

        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = [];

        for (let x = 0; x < columns; x++) {
            drops[x] = 1;
        }

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#00ff00';
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = chars.charAt(Math.floor(Math.random() * chars.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(drawMatrix, 33);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const columns = canvas.width / fontSize;
            drops.length = 0;
            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }
        });

        // Helper function to convert ArrayBuffer to binary string (for btoa)
        function arrayBufferToBinaryString(arrayBuffer) {
            let binaryString = '';
            const bytes = new Uint8Array(arrayBuffer);
            const length = bytes.byteLength;
            for (let i = 0; i < length; i++) {
                binaryString += String.fromCharCode(bytes[i]);
            }
            return binaryString;
        }

        // Function to fetch the transcript from S3, using a GET request to API Gateway
        async function fetchTranscript(s3KeyBase) {
            const fetchTranscriptUrl = `${API_BASE_URL}/transcripts/${encodeURIComponent(s3KeyBase)}`;
            console.log(`Attempting to fetch transcript from: ${fetchTranscriptUrl}`);
            try {
                const response = await fetch(fetchTranscriptUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        return null;
                    }
                    const errorDetails = await response.text();
                    throw new Error(`Failed to fetch transcript: ${response.status} - ${errorDetails}`);
                }
                const transcriptContent = await response.text();
                return transcriptContent;
            } catch (error) {
                console.error("Error fetching transcript:", error);
                messageDiv.textContent = `Error fetching transcript: ${error.message}`;
                return null;
            }
        }

        // Function to poll for the transcript, with a timeout
        async function pollForTranscript(s3KeyBase, timeout = 120000) {
            const startTime = Date.now();
            const interval = 3000;

            messageDiv.textContent = `Upload successful! Transcription initiated. Waiting for transcript... (Max ${timeout / 1000}s)`;
            loadingAnimationContainer.style.display = 'flex';

            let linesCreated = 0;
            const maxLines = 8;
            let animationIntervalId;

            const addLoadingLine = () => {
                if (linesCreated < maxLines) {
                    const line = document.createElement('div');
                    line.classList.add('loading-line');
                    if (Math.random() < 0.3) {
                        line.classList.add('flicker');
                    }
                    let lineLength = Math.floor(Math.random() * 20) + 10;
                    let lineText = '';
                    for (let i = 0; i < lineLength; i++) {
                        lineText += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    line.textContent = lineText;
                    loadingAnimationContainer.appendChild(line);
                    linesCreated++;
                    setTimeout(addLoadingLine, 200);
                }
            };

            const startLoadingAnimation = () => {
                loadingAnimationContainer.innerHTML = '';
                linesCreated = 0;
                addLoadingLine();
                animationIntervalId = setInterval(() => {
                    if (linesCreated < maxLines) {
                         addLoadingLine();
                    } else {
                        loadingAnimationContainer.innerHTML = '';
                        linesCreated = 0;
                        addLoadingLine();
                    }
                }, 2000);
            };

            startLoadingAnimation();

            while (Date.now() - startTime < timeout) {
                const transcriptText = await fetchTranscript(s3KeyBase);
                if (transcriptText !== null) {
                    clearInterval(animationIntervalId);
                    loadingAnimationContainer.style.display = 'none';
                    return transcriptText;
                }
                await new Promise(resolve => setTimeout(resolve, interval));
            }

            clearInterval(animationIntervalId);
            loadingAnimationContainer.style.display = 'none';
            throw new Error(`Timeout waiting for transcript to become available after ${timeout / 1000} seconds. The transcription might still be processing or failed.`);
        }

        function displayMatrixText(element, text, delay = 50) {
            if (!element || typeof text !== 'string') {
                console.error("displayMatrixText: Invalid element or text provided.", { element, text });
                return;
            }

            element.innerHTML = '';
            let i = 0;

            function typeChar() {
                if (i < text.length) {
                    const charSpan = document.createElement('span');
                    charSpan.classList.add('char');
                    charSpan.textContent = text.charAt(i);
                    element.appendChild(charSpan);

                    setTimeout(() => {
                        charSpan.classList.add('flicker');
                    }, 10);

                    i++;
                    setTimeout(typeChar, delay);
                } else {
                    console.log("Matrix text display complete.");
                }
            }

            console.log("Starting Matrix text display for length:", text.length);
            typeChar();
        }

        if (uploadForm) {
            uploadForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                console.log("Form submitted!");

                if (fileInput.files.length > 0) {
                    const selectedFile = fileInput.files[0];
                    console.log("Selected file:", selectedFile);
                    messageDiv.textContent = `Preparing to upload: ${selectedFile.name}`;
                    loadingAnimationContainer.innerHTML = '';
                    transcriptDiv.style.display = "none";
                    transcriptTextParagraph.innerHTML = '';

                    try {
                        const fileContent = await selectedFile.arrayBuffer();
                        const base64Content = btoa(arrayBufferToBinaryString(fileContent));

                        const uploadUrl = `${API_BASE_URL}/upload`;
                        console.log("Upload URL:", uploadUrl);

                        const response = await fetch(uploadUrl, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                fileName: selectedFile.name,
                                fileType: selectedFile.type,
                                fileContent: base64Content,
                            }),
                        });

                        if (response.ok) {
                            const data = await response.json();
                            console.log("Upload Response:", data);

                            const baseFileName = selectedFile.name.split('.').slice(0, -1).join('.');
                            console.log("Base file name for transcript polling:", baseFileName);

                            try {
                                const transcriptText = await pollForTranscript(baseFileName);
                                transcriptDiv.style.display = "block";
                                displayMatrixText(transcriptTextParagraph, transcriptText, 20);
                                messageDiv.textContent = "Transcription complete and displayed below!";
                            } catch (error) {
                                messageDiv.textContent = `Error: ${error.message}`;
                                console.error("Error during polling for transcript:", error);
                            }

                        } else {
                            let errorMessage = 'Unknown error occurred during upload.';
                            try {
                                const errorJson = await response.json();
                                errorMessage = errorJson.message || JSON.stringify(errorJson);
                            } catch (e) {
                                errorMessage = await response.text();
                            }
                            messageDiv.textContent = `Upload failed. Status: ${response.status} - ${errorMessage}`;
                            console.error("Upload Error:", response.status, { message: errorMessage });
                        }

                    } catch (error) {
                        messageDiv.textContent = `Error during upload or processing: ${error.message || error}`;
                        console.error("Upload Catch Error:", error);
                    }

                } else {
                    messageDiv.textContent = "Please choose an MP3 file to upload.";
                }
            });
        } else {
            console.error("Could not find the uploadForm element.");
            messageDiv.textContent = "Error: Application initialization failed. Missing form.";
        }

        // "Take the Blue Pill" button functionality
        if (bluePillButton) {
            bluePillButton.addEventListener("click", () => {
                document.body.innerHTML = `
                    <div style="background-color: #0000aa; color: #fff; font-family: 'Courier New', monospace; padding: 20px; text-align: left; height: 100vh; display: flex; flex-direction: column; justify-content: center;">
                        <p style="font-size: 24px; margin-bottom: 10px;">:( A problem has been detected and Matrix has been shut down to prevent damage to your Brain.</p>
                        <p style="font-size: 18px; margin-bottom: 10px;">The problem seems to be caused by the following file: <strong>NEOREVN.SYS</strong></p>
                        <p style="font-size: 18px; margin-bottom: 10px;">PAGE_FAULT_IN_NONPAGED_AREA</p>
                        <p style="font-size: 16px;">If this is the first time you've seen this stop error screen, restart your Brain. If this screen appears again, follow these steps:</p>
                        <ul style="font-size: 16px;">
                            <li>Check to make sure any new hardware or software is properly docked in and powered on. If this is a new installation, ask Ilya for any AWS updates you might need.</li>
                            <li>If problems continue, disable or remove any newly installed hardware or software. Disable MetaCortex memory options such as caching or shadowing. If you need to use Safe Mode to remove or disable components, restart your computer, press F8 to select Advanced Startup Options, and then select Safe Mode.</li>
                        </ul>
                        <p style="font-size: 16px;">Technical information:</p>
                        <p style="font-size: 14px;">*** STOP: 0x00000050 (0xFFFFF80000000000, 0x0000000000000001, 0xFFFFF80001004054, 0x0000000000000000)</p>
                        <p style="font-size: 14px;">*** NEOREVN.SYS - Address FFFFF80001004054 base at FFFFF80000000000, DateStamp 3e6e4e01</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
